# 14장 합의
- 이론적으로 합의 알고리즘의 3가지 속성:
  - 일치성: 모든 정상 프로세스는 동일한 값에 대해 합의한다.
  - 유효성: 합의 값은 참가 프로세스 중 한 프로세스가 제안한 값이다.
  - 유한성: 모든 정상 프로세스는 결국 합의에 도달한다.

## 브로드캐스트
- 통신 추상화
- 예시: 가십 전파
- 브로드캐스트의 신뢰성을 높이려면 송신 노드에 장애가 발생해도 모든 프로세스에 동일한 메시지를 전달할 수 있어야 한다.
- 메시지의 수는 줄이면서, 신뢰성 보장이 목표

## 원자적 브로드캐스트
- 원자성: 모든 프로세스가 전달받은 메시지는 일치한다. 모든 정상 프로세스가 메시지를 전달하거나 아예 전달하지 않아야 한다.
- 순서: 모든 정상 프로세스는 메시지를 같은 순서로 전달한다.

### 가상 동기화
- 그룹간 통신을 지원하는 대표적인 프레임워크
- 특정 뷰에서 보낸 메시지는 오직 해당 뷰 안에서만 전달될 수 있다.
- 메시지 브로드캐스트는 그룹 뷰를 넘나들 수 없다.
- 인기를 끌지 못했다.

### 주키퍼 원자적 브로드 캐스트
- 리더의 고유성을 보장하기 위해 프로토콜의 타임라인을 에포크로 나누고 단조 증가하는 식별 번호를 할당한다. 에포크별로 하나의 리더만이 존재할 수 있다.

- 리더 선출 프로토콜:
  - 발견단계
  - 동기화 단계
  - 브로드캐스트 단계

## 팍소스
- 원자적 브로드캐스트는 장애가 발생할 수 있는 비동기 시스템에서의 합의와 동등한 수준의 문제이다. 모든 참가 노드가 메시지 순서에 동의하고 알 수 있어야하기 때문이다.
- 팍소스 참가자:
  - 제안자
  - 수락자
  - 학습자

### 팍소스 알고리즘
- 선출: 리더 선출
  - 수락자가 아직 더 높은 번호의 제안에 응답하지 않은 경우, 더 낮은 번호의 제안에 응답하지 않을 것을 약속한다.
  - 수락자가 이미 다른 제안을 수락했을 경우, m번 제안을 수락했다는 것을 의미하는 Promise(m, vaccepted) 메시지로 제안자에게 응답한다.
  - 수락자가 이미 더 높은 번호의 제안을 수락했을 경우 더 높은 번호의 제안이 존재한다는 사실을 알린다.
  - 뒤에 수신한 요청의 번호가 더 높은한, 수락자는 여러 제안에 응답할 수 있다.
- 복제: 리더가 브로드캐스트할 값을 제안

### 팍소스에서의 쿼럼
### 장애 시나리오
### 멀티팍소스
- 복제단계마다 제안단계가 선행돼야하는 것은 문제이다.
- 특별 제안자라는 리더의 개념을 추가한다.

### 패스트 팍소스
### 평등주의적 팍소스
### 플렉서블 팍소스
## 합의를 도출하는 일반적인 방법들
## 래프트
- 이해와 구현이 쉬운 합의 알고리즘
- 후보자
- 리더
- 팔로워
- 클럭 동기화를 사용하지 않고 전역 부분 순서를 보장하기 위해 시간을 임기 단위로 나눈다. 임기 동안 리더는 하나만 존재하며 안정성이 보장된다. 임기는 단조 증가하는 숫자로 식별되며, 모든 작업은 임기 번호와 임기 내 메시지 번호의 조합으로 고유하게 식별된다.
- 래프트 알고리즘:
  - 리더 선출
  - 주기적 하트비트
  - 로그 복제/브로드캐스트

### 래프트의 리더
### 장애 시나리오
- 래프트 알고리즘의 속성:
  - 임기 동안 하나의 리더만 선출될 수 있다. 같은 임기동안 여러 리더가 동시에 존재할 수 없다.
  - 리더는 자신의 로그 항목을 삭제하거나 재배치하지 않고 새로운 메시지를 추가만 한다.
  - 리더는 모든 로그 항목을 커밋하기 전에 우선 복제하기 때문에 커밋된 항목은 모든 리더가 공통적으로 저장하며 이를 되돌릴 수 없다.
  - 로그 항목은 커밋 전 먼저 복제되기 때문에 모든 차기 리더의 로그에 존재한다.
  - 메시지는 메시지 번호와 임기 ID 로 식별된다. 식별자는 다른 항목에 재사용될 수 없다.

## 비잔틴 합의
- 비잔틴 장애를 허용하는 합의 알고리즘
- PBFT:
  - 변형
  - PoW
  - Hyperledger Fabric
  - pBFT + DPos(Delegated Proof-of-Stake)

- cf. pow vs pos
